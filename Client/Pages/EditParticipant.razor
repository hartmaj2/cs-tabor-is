@page "/participants/edit/{participantId:int}"
@inject HttpClient Http

<PageTitle> Edit participant </PageTitle>

@if (participant != null)
{
    <h1> Edit participant </h1>
    <ParticipantForm @bind-ThisParticipant="participant" OnValidSubmitEvent="UpdateParticipant" OnInvalidSubmitEvent="()=>updated = false"> Confirm </ParticipantForm>
    if (updated)
    {
        <p style="color:green"> Update successful </p>
    }
}
else
{
    <p> Loading... </p>
}

@code
{
    private bool updated = false;

    [Parameter]
    public int ParticipantId {get ; set; }

    private IEnumerable<AllergenDto>? allAllergens { get; set; }

    ParticipantFormData? participant;

    protected override async Task OnInitializedAsync()
    {
        await LoadAllergens();
        ParticipantDto? content = await Http.GetFromJsonAsync<ParticipantDto>($"/api/participants/{ParticipantId}");
        participant = content!.ConvertToParticipantFormData(allAllergens!);
        
    }

    private async Task LoadAllergens()
    {
        allAllergens = await Http.GetFromJsonAsync<List<AllergenDto>>("api/allergens/all");
    }

    private void UpdateParticipant()
    {
        Http.PostAsJsonAsync<ParticipantDto>($"/api/participants/edit/{ParticipantId}",participant!.ConvertToParticipantDto(ParticipantId),CancellationToken.None);
        updated = true;
    }
}