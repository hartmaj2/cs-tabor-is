@namespace Client.Components

<div class="modal-div">

    <div class="modal-section-headers"> 
        <div class="modal-section-header"> <div> General information </div> </div>
        <div class="modal-section-header"> <div> Diets </div> </div>
    </div>

    <div class="modal-sections">
        <div class="modal-section">
            @* Use my custom component with 2-way-binding to its value *@
            <ParticipantForm @bind-ThisParticipant="Participant" OnValidSubmitEvent="OnFormSubmit"> Confirm </ParticipantForm> 
        </div>

        @if (Participant.DietSelections != null)
        {
            <div class="modal-section">
                <div class="modal-allergen-selections">       
                    @foreach (var selection in Participant.DietSelections)
                    {
                        <div class="modal-allergen-selection">
                            <div style="flex:2"></div>
                            <label style="flex: 3"> <input type="checkbox" @bind="selection.IsSelected"> @selection.Name </label>
                            <div style="flex:1"></div>
                        </div>
                        
                    }
                </div>
            </div>
        }
        else
        {
            <p> Loading diets.. </p>
        }
    </div>
</div>
@code
{
    
    public ParticipantFormData Participant { get; set; } = ParticipantFormData.CreateDefault();
    [Parameter]
    public EventCallback<ParticipantFormData> CreateParticipant { get; set; }

    [Parameter]
    public IEnumerable<AllergenDto>? AllAllergens { get; set; }

    private void OnFormSubmit()
    {
        CreateParticipant.InvokeAsync(Participant);
        ResetParticipantFormData();
    }

    protected override void OnInitialized()
    {
        InitializeParticipantDietSelections();
    }

    private void ResetParticipantFormData()
    {
        Participant = ParticipantFormData.CreateDefault();
        InitializeParticipantDietSelections();
    }

    private void InitializeParticipantDietSelections()
    {
        Participant.DietSelections = AllAllergens!.Select(allergen => new AllergenSelection() {Name = allergen.Name }).ToList();
    }
}
